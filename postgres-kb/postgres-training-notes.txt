=====================================
      POSTGRES TRAINING NOTES
=====================================
SITES:
https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server
commitfest.postgresql.org

MISC:
MariaDB is not opensource anymore - they have a new capability 'max...' so not opensource anymore

BASICSL
Default port - 5432
Binaries - /usr/pgsql-<version>/bin 
Data - /var/lib/pgsql/<version>/data
Config files - in Data directory - postgresql.conf, postgresql.auto.conf, pg_hba.conf, pg_ident.conf
SQL client 'psql' - /usr/bin/psql -> /etc/alternatives/pgsql-psql
Postgres is extensible - can define new datatypes, functions, can use other languages for stored procs (like JS, Java...)

ARCHITECTURE:
http://raghavt.blogspot.in/2012/04/caching-in-postgresql.html
http://patshaughnessy.net/2016/1/22/is-your-postgres-query-starved-for-memory
http://rhaas.blogspot.in/2012/03/tuning-sharedbuffers-and-walbuffers.html

Datafiles (data folder) - uses regular filesystems
Memory - 
  Shared buffers (shared_buffers)--> set to upto 25% of system memory
  Page cache (not really set - it is just 'remaining os mem') --> recently read/written data - similar to db_block_buffers of Oracle
  Query memory
  Max connections (small memory used by connections)
  work_mem (dynamic at system, user, session level) --> for query-sorts etc, typically small like 4-16MB, 
      4MB good for most OLTP systems, large operations do multiple passes, and use temp files
      psql> alter user username set work_mem=128MB (to set at user level - applies  to all queries of the user)
  maintenance_work_mem (dynamic) - for maintenance operations like create index that needs sort data (could be set high like a GB)
  wal_buffers - 
  temp_buffers - 
  effective_cache_size (only a hint) - 

Temporary files - created as needed (similar to temp tablespace of Oracle)

Checkpoints and background writer:
      min_, max_wal_size
      checkpoint_timeout --> default 5 min, increase it to 30 min or so to avoid too much checkpoint write overhead
      checkpoint_completion_target
      bgrwriter_delay
      bgwriter_lru_maxpages
      bgwriter_lru_multiplier

There is no UNDO - only REDO
      Copies of modified data are written in the datafile itself - with a transaction ID. 
      When queried, latest comes up, and older ones are eventually cleared.

CHECK STATUS OF THE SERVICE:
$ pg_ctl status -D /var/lib/pgsql/9.5/data
pg_ctl: server is running (PID: 3124)
/usr/pgsql-9.5/bin/postgres "-D" "/var/lib/pgsql/9.5/data"

STOP THE SERVICE:
$ pg_ctl stop -D /var/lib/pgsql/9.5/data
waiting for server to shut down.... done
server stopped

START THE SERVICE:
$ pg_ctl start -D /var/lib/pgsql/9.5/data

CAUTION:
You can run multiple instances to run on the same machine - however it is NOT ADVISABLE
--> One instance may hog up all CPU and the others are starved
--> 

TABLESPACES:
Not advisable as the 'restore' server should have the same folder structure??
Tablespaces are probably good when we have to host one DB on SSD, other on traditional disks etc.

BACKUPS:
CAUTION: Hot/physical backups are at instance level - so if instance becomes too large then backup/recovery becomes difficult
            For this, create VMs and distribute databases across multiple instances on those VMs

MANAGEMENT TOOLS:
$ pg_ctl
# /etc/init.d/postgres*
# service postgresql-9.5 initdb
      The service command supports only basic LSB actions (start, stop, restart, try-restart, reload, force-reload, status). 
      For other actions, please try to use systemctl.

CONNECTIVITY CONFIGURATION:
postgresql.conf
listen_addresses = 'localhost,127.0.0.1,<local actual hostname>'
#listen_addresses = '*'
#listen_addresses = 'localhost'         # what IP address(es) to listen on;

CLIENT AUTHENTICATION CONFIGURATION:
pg_hba.conf

INSTANCE CONFIGURATION:
postgresql.conf

DYNAMIC CONFIGURATION CHANGES:
ALTER SYSTEM SET max_connections=200;
- stored in postgresql.auto.conf
- overrides postgresql.conf
- always in dat dir, irrespective of where postgresql.conf is stored
Needs to restart/reload to take effect in the file :
--> some need restart of postgres itself
--> some work with pg_reload_conf (like work_mem)
      psql# alter system set work_mem=5000;
      psql#  select pg_reload_conf();
       pg_reload_conf
      ----------------
       t
      (1 row)
      
      psql# show work_mem;
       work_mem
      ----------
       5000kB
      (1 row)

OPTIMAL CONNECTIONS:
Optimal - twice the cores active connections (also factor in the connections by admins etc)
max_connections=100 is default - but assumes most connections idle if CPUs are less

SHARED_BUFFERS:
This is for data read from disk
Do not keep it very large as it is expensive to manage??
Postgres uses page caches...??

WORK_MEM:
For intermediate results of query

