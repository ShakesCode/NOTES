=================================================
CHEF DEVELOPMENT WITH KITCHEN, BERKSHELF, VAGRANT
=================================================

BASED ON - http://www.davidmataro.com/chef-development-workflow-with-kitchen-berkshelf-vagrant

https://github.com/chef/omnitruck/issues/78

SSL issue: (was 'kitchen converge' ssl certificate errors due to proxy settings - as it worked well from home)
https://groups.google.com/forum/#!topic/vagrant-up/MHmAg0DOQic
https://github.com/chef/chef-dk/issues/106
https://curl.haxx.se/docs/sslcerts.html
https://github.com/test-kitchen/kitchen-docker/issues/72 --> proxy settings
http://stackoverflow.com/questions/35519389/vagrant-cannot-find-box --> says do 'vagrant box add ubuntu/trusty64' manually

Proxy settings:
https://www.kickflop.net/blog/2015/10/28/using-test-kitchen-and-kitchen-vagrant-behind-an-http-proxy/  (READ THIS)
https://github.com/test-kitchen/test-kitchen/issues/1020 (has some extended discussion)

https://docs.chef.io/config_yml_kitchen.html
https://github.com/tmatilai/vagrant-proxyconf/issues/64
https://github.com/tmatilai/vagrant-proxyconf/pull/21
https://github.com/test-kitchen/kitchen-vagrant/issues/90

================================
PROJECT WORKSPACE AND REPOSITORY
================================

- WHAT IS A REPOSITORY
A project repository with the cookbooks and other stuff.

The project contains:
  cookbooks
  roles
  environments
  data_bags

  A Berksfile inside the project repository.
  A .kitchen.yml definition inside the project repository.

- CREATE PROJECTS DIRECTORY
$ mkdir projects
$ cd projects

- CREATE A REPOSITORY FOR A STACK 'MYSTACK' 
$ chef generate app mystack
(screen output further below)

This creates the following files:
NOTE: The cookbooks directory in it

mystack/
  |__ .git
  |__ .gitignore
  |__ .kitchen.yml
  |__ README.md
  |__ cookbooks/
  |    |__ mystack/
  |__ test

- CREATE BERKSFILE
NOTE: You can add into Berskfile file as many cookbooks as you wish. 
NOTE: Each cookbook have their own metadata.rb with their dependencies.

Create a Berksfile inside mystack directory and add your cookbooks.

Content of 'Berksfile' file:
source "https://supermarket.chef.io"
cookbook "mystack", path: "cookbooks/mystack"

- CREATE .kitchen.yml in mystack folder
NOTE: Proxy settings were not done here - they were done in os environment

---
driver:
  name: vagrant

provisioner:
  name: chef_zero
  cookbook_path: cookbooks
  roles_path: roles
  environments_path: environments
  data_bags_path: data_bags
  client_rb:
    environment: development

platforms:
  - name: ubuntu/trusty64

suites:
  - name: default
    driver:
      vm_hostname: mystack.loc
      network:
      - ["private_network", {ip: "10.0.0.31",virtualbox__intnet: true}]
      customize:
        memory: 512
        cpus: 1
    run_list:
      - recipe[mystack::default]
    attributes:
   
- CREATE DEVELOPMENT.JSON FILE

Because I use a development environment in my .kitchen.yml file configuration, 
I need create a environment/development.json file.

{
  "name": "development",
  "description": "Development environment",
  "cookbook_versions": {
  },
  "json_class": "Chef::Environment",
  "chef_type": "environment",
  "default_attributes": {
    "authorization": {
      "sudo": {
        "users": [
          "vagrant"
        ]
      }
    }
  },
  "override_attributes": {
  }
}

- INSTALL COOKBOOKS USING BERKSHELF

To download all cookbooks dependencies run the next command:

berks install

NOTE: By default all the cookbook dependencies are located at '~/.berkshelf/cookbooks' (G:\home\.berkshelf\cookbooks in Bills Kitchen) 
NOTE: And each cookbook is named using the convention {name}-{version}.

- KITCHEN CONVERGE
Finally, run 'kitchen converge' to start a vagrant virtual machine and install and configure all the software components.

$ cd projects/mystack
$ kitchen converge default

- KITCHEN PROVISION
TBD

- UPLOAD COOKBOOKS TO CHEF SERVER
To upload all cookbooks to Chef server, you must create a knife.rb configuration inside the .chef/ directory, 
add the validation and user keys and run:

$ berks upload

==================================
PROXY SETTINGS 
==================================
You may get SSL/CACERT errors if behind proxy - in the vagrant execution during 'kitchen converge' run.
To avoid that, set proxy environnment variables - either in o/s environment or in kitchen.yml.

-----------------
IN OS ENVIRONMENT
-----------------
set http_proxy=http://yourproxy.example.com:80
set https_proxy=https://yourproxy.example.com:80

--------------
IN KITCHEN.YML
--------------

NOTE: http_proxy_user and http_proxy_password (and so https_ also) may be needed for sections under provisioners

https://www.kickflop.net/blog/2015/10/28/using-test-kitchen-and-kitchen-vagrant-behind-an-http-proxy/

Using test-kitchen and kitchen-vagrant behind an HTTP proxy
Hereâ€™s what got us working with test-kitchen and kitchen-vagrant behind an HTTP proxy. Comments inline.

---
driver:
  name: vagrant
  driver_config:
    # Allows fetching boxes if required
    http_proxy: http://yourproxy.example.com:80
    https_proxy: https://yourproxy.example.com:80
  # This vagrantfiles callout is needed because of
  # https://github.com/test-kitchen/test-kitchen/issues/821
  # You should check that issue to see if this is still required.
  vagrantfiles:
    - your-site-specific-vagrantfile-block.rb
  network:
    - ["private_network", {ip: "192.168.1.2"}]

provisioner:
  name: chef_zero
  # Allows fetching Omnibus Chef installer if required
  http_proxy: http://yourproxy.example.com:80
  https_proxy: http://yourproxy.example.com:80

platforms:
  - name: centos-6.7

suites:
  - name: default
    run_list:
      - recipe[things::default]
    attributes:
      chef-client:
        # Allows your Chef run to fetch stuff it requires
        config:
          http_proxy: "http://yourproxy.example.com:80"
          https_proxy: "http://yourproxy.example.com:80"
And finally your-site-specific-vagrantfile-block.rb, your custom Vagrantfile piece that is merged in via the vagrantfiles directive in your YAML file:

unless Vagrant.has_plugin?("vagrant-proxyconf")
  raise "Missing required plugin 'vagrant-proxyconf', run `vagrant plugin install vagrant-proxyconf`"
end

Vagrant.configure(2) do |config|
  # Allows busser gem and deps to be fetched as required
  config.proxy.http     = "#{ENV['http_proxy']}"
  config.proxy.https    = "#{ENV['https_proxy']}"
  config.proxy.no_proxy = "localhost,127.0.0.1"
end

==========================
RUN KITCHEN CONVERGE
==========================
G:\projects\mystack> kitchen converge

The run gave an error - see KITCHEN CONVERGE ERROR2 in MISCELLANEOUS STUFF section 
- AND IT WAS PLACED IN /tmp/kitchen/cache/chef-stacktrace.out in the VM 
    (see KITCHEN CONVERGE ERROR3 and KITCHEN CONVERGE ERROR3A sections)

TBD - debug and fix this error

HOWEVER, IT SEEMED TO HAVE CREATED THE VM ALRIGHT

=========================
LOGON TO VM AND CHECK
=========================
This will take you to the VM:
G:\projects\mystack> kitchen login

----------
In the VM:
----------
Hostname: as given in kitchen.yml, except that the suffix is not there in the VM

$ hostname
mystack

SSH ID: Vagrant as expected for vagrant provisioner

$ id
uid=1000(vagrant) gid=1000(vagrant) groups=1000(vagrant)

Sudo to root:
$ sudo su
#

Check network: 
NOTE: The IP specified in kitchen.yml has been created (10.0.0.31)

# ifconfig
eth0      Link encap:Ethernet  HWaddr 08:00:27:12:3e:d8
          inet addr:10.0.2.15  Bcast:10.0.2.255  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fe12:3ed8/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:45179 errors:0 dropped:0 overruns:0 frame:0
          TX packets:14609 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:39162113 (39.1 MB)  TX bytes:990660 (990.6 KB)

eth1      Link encap:Ethernet  HWaddr 08:00:27:b6:a5:cf
          inet addr:10.0.0.31  Bcast:10.0.0.255  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:feb6:a5cf/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:8 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 B)  TX bytes:648 (648.0 B)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)


======================
MISCELLANEOUS STUFF
======================
------------------------------------
OUTPUT OF CHEF GENERATE APP MYSTACK
------------------------------------
G:\projects>chef generate app mystack
Installing Cookbook Gems:
Compiling Cookbooks...
Recipe: code_generator::app
  * directory[G:/projects/mystack] action create
    - create new directory G:/projects/mystack
  * template[G:/projects/mystack/.kitchen.yml] action create
    - create new file G:/projects/mystack/.kitchen.yml
    - update content in file G:/projects/mystack/.kitchen.yml from none to dad5ad
    (diff output suppressed by config)
  * directory[G:/projects/mystack/test/integration/default/serverspec] action create
    - create new directory G:/projects/mystack/test/integration/default/serverspec
  * directory[G:/projects/mystack/test/integration/helpers/serverspec] action create
    - create new directory G:/projects/mystack/test/integration/helpers/serverspec
  * cookbook_file[G:/projects/mystack/test/integration/helpers/serverspec/spec_helper.rb] action create_if_missing
    - create new file G:/projects/mystack/test/integration/helpers/serverspec/spec_helper.rb
    - update content in file G:/projects/mystack/test/integration/helpers/serverspec/spec_helper.rb from none to d85df4
    (diff output suppressed by config)
  * template[G:/projects/mystack/test/integration/default/serverspec/default_spec.rb] action create_if_missing
    - create new file G:/projects/mystack/test/integration/default/serverspec/default_spec.rb
    - update content in file G:/projects/mystack/test/integration/default/serverspec/default_spec.rb from none to 85cbc2
    (diff output suppressed by config)
  * template[G:/projects/mystack/README.md] action create
    - create new file G:/projects/mystack/README.md
    - update content in file G:/projects/mystack/README.md from none to 7a87fb
    (diff output suppressed by config)
  * directory[G:/projects/mystack/cookbooks] action create
    - create new directory G:/projects/mystack/cookbooks
  * directory[G:/projects/mystack/cookbooks/mystack] action create
    - create new directory G:/projects/mystack/cookbooks/mystack
  * template[G:/projects/mystack/cookbooks/mystack/metadata.rb] action create
    - create new file G:/projects/mystack/cookbooks/mystack/metadata.rb
    - update content in file G:/projects/mystack/cookbooks/mystack/metadata.rb from none to c33348
    (diff output suppressed by config)
  * cookbook_file[G:/projects/mystack/cookbooks/mystack/chefignore] action create
    - create new file G:/projects/mystack/cookbooks/mystack/chefignore
    - update content in file G:/projects/mystack/cookbooks/mystack/chefignore from none to 15fac5
    (diff output suppressed by config)
  * cookbook_file[G:/projects/mystack/cookbooks/mystack/Berksfile] action create
    - create new file G:/projects/mystack/cookbooks/mystack/Berksfile
    - update content in file G:/projects/mystack/cookbooks/mystack/Berksfile from none to 9f08dc
    (diff output suppressed by config)
  * directory[G:/projects/mystack/cookbooks/mystack/recipes] action create
    - create new directory G:/projects/mystack/cookbooks/mystack/recipes
  * template[G:/projects/mystack/cookbooks/mystack/recipes/default.rb] action create
    - create new file G:/projects/mystack/cookbooks/mystack/recipes/default.rb
    - update content in file G:/projects/mystack/cookbooks/mystack/recipes/default.rb from none to 5296c4
    (diff output suppressed by config)
  * directory[G:/projects/mystack/cookbooks/mystack/spec/unit/recipes] action create
    - create new directory G:/projects/mystack/cookbooks/mystack/spec/unit/recipes
  * cookbook_file[G:/projects/mystack/cookbooks/mystack/spec/spec_helper.rb] action create_if_missing
    - create new file G:/projects/mystack/cookbooks/mystack/spec/spec_helper.rb
    - update content in file G:/projects/mystack/cookbooks/mystack/spec/spec_helper.rb from none to 587075
    (diff output suppressed by config)
  * template[G:/projects/mystack/cookbooks/mystack/spec/unit/recipes/default_spec.rb] action create_if_missing
    - create new file G:/projects/mystack/cookbooks/mystack/spec/unit/recipes/default_spec.rb
    - update content in file G:/projects/mystack/cookbooks/mystack/spec/unit/recipes/default_spec.rb from none to 2ee54c
    (diff output suppressed by config)
  * execute[initialize-git] action run
    - execute git init .
  * cookbook_file[G:/projects/mystack/.gitignore] action create
    - create new file G:/projects/mystack/.gitignore
    - update content in file G:/projects/mystack/.gitignore from none to 33d469
    (diff output suppressed by config)

------------------------------------------
KITCHEN CONVERGE SSL/CERT ERROR
------------------------------------------
G:\projects\mystack>kitchen converge default                                                                               
-----> Starting Kitchen (v1.6.0)                                                                                           
-----> Creating <default-ubuntu-trusty64>...                                                                               
       Bringing machine 'default' up with 'virtualbox' provider...                                                         
       ==> default: Box 'ubuntu/trusty64' could not be found. Attempting to find and install...                            
           default: Box Provider: virtualbox                                                                               
           default: Box Version: >= 0                                                                                      
       The box 'ubuntu/trusty64' could not be found or                                                                     
       could not be accessed in the remote catalog. If this is a private                                                   
       box on HashiCorp's Atlas, please verify you're logged in via                                                        
       `vagrant login`. Also, please double-check the name. The expanded                                                   
       URL and error message are shown below:                                                                              
                                                                                                                           
       URL: ["https://atlas.hashicorp.com/ubuntu/trusty64"]                                                                
       Error: SSL certificate problem: self signed certificate in certificate chain                                        
       More details here: http://curl.haxx.se/docs/sslcerts.html                                                           
                                                                                                                           
       curl performs SSL certificate verification by default, using a "bundle"                                             
        of Certificate Authority (CA) public keys (CA certs). If the default                                               
        bundle file isn't adequate, you can specify an alternate file                                                      
        using the --cacert option.                                                                                         
       If this HTTPS server uses a certificate signed by a CA represented in                                               
        the bundle, the certificate verification probably failed due to a                                                  
        problem with the certificate (it might be expired, or the name might                                               
        not match the domain name in the URL).                                                                             
       If you'd like to turn off curl's verification of the certificate, use                                               
        the -k (or --insecure) option.                                                                                     
>>>>>> ------Exception-------                                                                                              
>>>>>> Class: Kitchen::ActionFailed                                                                                        
>>>>>> Message: Failed to complete #create action: [Expected process to exit with [0], but received '1'                    
---- Begin output of vagrant up --no-provision --provider virtualbox ----                                                  
STDOUT: Bringing machine 'default' up with 'virtualbox' provider...                                                        
==> default: Box 'ubuntu/trusty64' could not be found. Attempting to find and install...                                   
    default: Box Provider: virtualbox                                                                                      
    default: Box Version: >= 0                                                                                             
STDERR: The box 'ubuntu/trusty64' could not be found or                                                                    
could not be accessed in the remote catalog. If this is a private                                                          
box on HashiCorp's Atlas, please verify you're logged in via                                                               
`vagrant login`. Also, please double-check the name. The expanded                                                          
URL and error message are shown below:                                                                                     
                                                                                                                           
URL: ["https://atlas.hashicorp.com/ubuntu/trusty64"]                                                                       
Error: SSL certificate problem: self signed certificate in certificate chain                                               
More details here: http://curl.haxx.se/docs/sslcerts.html                                                                  
                                                                                                                           
curl performs SSL certificate verification by default, using a "bundle"                                                    
 of Certificate Authority (CA) public keys (CA certs). If the default                                                      
 bundle file isn't adequate, you can specify an alternate file                                                             
 using the --cacert option.                                                                                                
If this HTTPS server uses a certificate signed by a CA represented in                                                      
 the bundle, the certificate verification probably failed due to a                                                         
 problem with the certificate (it might be expired, or the name might                                                      
 not match the domain name in the URL).                                                                                    
If you'd like to turn off curl's verification of the certificate, use                                                      
 the -k (or --insecure) option.                                                                                            
---- End output of vagrant up --no-provision --provider virtualbox ----                                                    
Ran vagrant up --no-provision --provider virtualbox returned 1]                                                            
>>>>>> ----------------------                                                                                              
>>>>>> Please see .kitchen/logs/kitchen.log for more details                                                               
>>>>>> Also try running `kitchen diagnose --all` for configuration                                                         
                                                                                                                           
------------------------------------
KITCHEN CONVERGE ERROR2
------------------------------------
g:\projects\mystack>kitchen converge
-----> Starting Kitchen (v1.6.0)
-----> Creating <default-ubuntu-trusty64>...
       Bringing machine 'default' up with 'virtualbox' provider...
       ==> default: Checking if box 'ubuntu/trusty64' is up to date...
       ==> default: Fixed port collision for 22 => 2222. Now on port 2200.
       ==> default: Clearing any previously set network interfaces...
       ==> default: Preparing network interfaces based on configuration...
           default: Adapter 1: nat
           default: Adapter 2: intnet
       ==> default: Forwarding ports...
           default: 22 (guest) => 2200 (host) (adapter 1)
       ==> default: Running 'pre-boot' VM customizations...
       ==> default: Booting VM...
       ==> default: Waiting for machine to boot. This may take a few minutes...
           default: SSH address: 127.0.0.1:2200
           default: SSH username: vagrant
           default: SSH auth method: private key
           default: Warning: Remote connection disconnect. Retrying...
           default:
           default: Vagrant insecure key detected. Vagrant will automatically replace
           default: this with a newly generated keypair for better security.
           default:
           default: Inserting generated public key within guest...
           default: Removing insecure key from the guest if it's present...
           default: Key inserted! Disconnecting and reconnecting using new SSH key...
       ==> default: Machine booted and ready!
       ==> default: Checking for guest additions in VM...
       ==> default: Setting hostname...
       ==> default: Configuring and enabling network interfaces...
       ==> default: Configuring proxy for Apt...
       ==> default: Configuring proxy environment variables...
       ==> default: Machine not provisioned because `--no-provision` is specified.
       [SSH] Established
       Vagrant instance <default-ubuntu-trusty64> created.
       Finished creating <default-ubuntu-trusty64> (1m16.55s).
-----> Converging <default-ubuntu-trusty64>...
       Preparing files for transfer
       Preparing dna.json
       Resolving cookbook dependencies with Berkshelf 4.3.0...
       Removing non-cookbook files before transfer
       Preparing data_bags
       Preparing environments
       Preparing roles
       Preparing validation.pem
       Preparing client.rb
-----> Installing Chef Omnibus (install only if missing)
       Downloading https://www.chef.io/chef/install.sh to file /tmp/install.sh
       Trying wget...
       Download complete.
       ubuntu 14.04 x86_64
       Getting information for chef stable  for ubuntu...
       downloading https://omnitruck-direct.chef.io/stable/chef/metadata?v=&p=ubuntu&pv=14.04&m=x86_64
         to file /tmp/install.sh.2625/metadata.txt
       trying wget...
       sha1     a316f74e4a08fd4d2c535460c3aa16d30e09a08e
       sha256   fbf44670ab5b76e4f1a1f5357885dafcc79e543ccbbe3264afd40c15d604b6dc
       url      https://packages.chef.io/files/stable/chef/12.19.36/ubuntu/14.04/chef_12.19.36-1_amd64.deb
       version  12.19.36
       downloaded metadata file looks valid...
       downloading https://packages.chef.io/files/stable/chef/12.19.36/ubuntu/14.04/chef_12.19.36-1_amd64.deb
         to file /tmp/install.sh.2625/chef_12.19.36-1_amd64.deb
       trying wget...
       Comparing checksum with sha256sum...

       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING

       You are installing an omnibus package without a version pin.  If you are installing
       on production servers via an automated process this is DANGEROUS and you will
       be upgraded without warning on new releases, even to new major releases.
       Letting the version float is only appropriate in desktop, test, development or
       CI/CD environments.

       WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING WARNING

       Installing chef
       installing with dpkg...
(Reading database ... 63122 files and directories currently installed.)
       Preparing to unpack .../chef_12.19.36-1_amd64.deb ...
        * Stopping chef-client chef-client                               [ OK ]
       Unpacking chef (12.19.36-1) over (11.8.2-2) ...
       dpkg: warning: unable to delete old directory '/var/log/chef': Directory not empty
       dpkg: warning: unable to delete old directory '/etc/chef': Directory not empty
       Setting up chef (12.19.36-1) ...
       Thank you for installing Chef!
       Processing triggers for man-db (2.6.7.1-1ubuntu1) ...
       Transferring files to <default-ubuntu-trusty64>
       Starting Chef Client, version 12.19.36
       Creating a new client identity for default-ubuntu-trusty64 using the validator key.

       ================================================================================
       Error expanding the run_list:
       ================================================================================

       Unexpected API Request Failure:
       -------------------------------
       Object not found: chefzero://localhost:8889/environments/development

       Platform:
       ---------
       x86_64-linux


       Running handlers:
       [2017-03-02T09:33:58+00:00] ERROR: Running exception handlers
       Running handlers complete
       [2017-03-02T09:33:58+00:00] ERROR: Exception handlers complete
       Chef Client failed. 0 resources updated in 02 seconds
       [2017-03-02T09:33:58+00:00] FATAL: Stacktrace dumped to /tmp/kitchen/cache/chef-stacktrace.out
       [2017-03-02T09:33:58+00:00] FATAL: Please provide the contents of the stacktrace.out file if you file a bug report
       [2017-03-02T09:33:58+00:00] ERROR: 404 "Not Found"
       [2017-03-02T09:33:58+00:00] FATAL: Chef::Exceptions::ChildConvergeError: Chef run process exited unsuccessfully (exit code 1)
>>>>>> Converge failed on instance <default-ubuntu-trusty64>.
>>>>>> Please see .kitchen/logs/default-ubuntu-trusty64.log for more details
>>>>>> ------Exception-------
>>>>>> Class: Kitchen::ActionFailed
>>>>>> Message: SSH exited (1) for command: [sh -c '
http_proxy="http://proxyserver.company.com:3128"; export http_proxy
HTTP_PROXY="http://proxyserver.company.com:3128"; export HTTP_PROXY
https_proxy="http://proxyserver.company.com:3128"; export https_proxy
HTTPS_PROXY="http://proxyserver.company.com:3128"; export HTTPS_PROXY
no_proxy="127.0.0.1,localhost,company.com,corp.company.com,hq.company.com,dist.company.com,Email.company.com,stores.company.com,labs.company.com"; export no_proxy
NO_PROXY="127.0.0.1,localhost,company.com,corp.company.com,hq.company.com,dist.company.com,Email.company.com,stores.company.com,labs.company.com"; export NO_PROXY
sudo -E /opt/chef/bin/chef-client --local-mode --config /tmp/kitchen/client.rb --log_level warn --force-formatter --no-color --json-attributes /tmp/kitchen/dna.json --chef-zero-port 8889
']
>>>>>> ----------------------
zlib(finalizer): the stream was freed prematurely.

g:\projects\mystack>{virtualbox__intnet: true}
'{virtualbox__intnet:' is not recognized as an internal or external command,
operable program or batch file.

==================================
KITCHEN CONVERGE ERROR3
==================================


# cat /tmp/kitchen/cache/chef-stacktrace.out
Generated at 2017-03-02 10:20:20 +0000
Net::HTTPServerException: 404 "Not Found"
/opt/chef/embedded/lib/ruby/2.3.0/net/http/response.rb:120:in `error!'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/http.rb:150:in `request'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/http.rb:115:in `get'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/environment.rb:250:in `load'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/node.rb:434:in `apply_expansion_attributes'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/node.rb:423:in `expand!'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/policy_builder/expand_node_object.rb:173:in `expand_run_list'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/policy_builder/expand_node_object.rb:157:in `build_node'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/client.rb:484:in `build_node'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/client.rb:272:in `run'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/application.rb:295:in `block in fork_chef_client'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/application.rb:283:in `fork'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/application.rb:283:in `fork_chef_client'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/application.rb:248:in `block in run_chef_client'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/local_mode.rb:44:in `with_server_connectivity'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/application.rb:236:in `run_chef_client'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/application/client.rb:464:in `sleep_then_run_chef_client'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/application/client.rb:451:in `block in interval_run_chef_client'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/application/client.rb:450:in `loop'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/application/client.rb:450:in `interval_run_chef_client'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/application/client.rb:434:in `run_application'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/lib/chef/application.rb:59:in `run'
/opt/chef/embedded/lib/ruby/gems/2.3.0/gems/chef-12.19.36/bin/chef-client:26:in `<top (required)>'
/opt/chef/bin/chef-client:57:in `load'
/opt/chef/bin/chef-client:57:in `<main>

========================================
KITCHEN CONVERGE ERROR3A
========================================
I, [2017-03-02T16:12:15.320209 #9108]  INFO -- default-ubuntu-trusty64: -----> Converging <default-ubuntu-trusty64>...
I, [2017-03-02T16:12:15.333212 #9108]  INFO -- default-ubuntu-trusty64: Preparing files for transfer
I, [2017-03-02T16:12:15.335712 #9108]  INFO -- default-ubuntu-trusty64: Preparing dna.json
I, [2017-03-02T16:12:15.341213 #9108]  INFO -- default-ubuntu-trusty64: Resolving cookbook dependencies with Berkshelf 4.3.0...
I, [2017-03-02T16:12:15.509747 #9108]  INFO -- default-ubuntu-trusty64: Removing non-cookbook files before transfer
I, [2017-03-02T16:12:15.526250 #9108]  INFO -- default-ubuntu-trusty64: Preparing data_bags
I, [2017-03-02T16:12:15.529251 #9108]  INFO -- default-ubuntu-trusty64: Preparing environments
I, [2017-03-02T16:12:15.533252 #9108]  INFO -- default-ubuntu-trusty64: Preparing roles
I, [2017-03-02T16:12:15.536252 #9108]  INFO -- default-ubuntu-trusty64: Preparing validation.pem
I, [2017-03-02T16:12:15.541253 #9108]  INFO -- default-ubuntu-trusty64: Preparing client.rb
I, [2017-03-02T16:12:15.959337 #9108]  INFO -- default-ubuntu-trusty64: -----> Chef Omnibus installation detected (install only if missing)
I, [2017-03-02T16:12:15.996344 #9108]  INFO -- default-ubuntu-trusty64: Transferring files to <default-ubuntu-trusty64>
I, [2017-03-02T16:12:18.338813 #9108]  INFO -- default-ubuntu-trusty64: Starting Chef Client, version 12.19.36
I, [2017-03-02T16:12:20.505246 #9108]  INFO -- default-ubuntu-trusty64: 
I, [2017-03-02T16:12:20.508247 #9108]  INFO -- default-ubuntu-trusty64: ================================================================================
I, [2017-03-02T16:12:20.518749 #9108]  INFO -- default-ubuntu-trusty64: Error expanding the run_list:
I, [2017-03-02T16:12:20.525750 #9108]  INFO -- default-ubuntu-trusty64: ================================================================================
I, [2017-03-02T16:12:20.544254 #9108]  INFO -- default-ubuntu-trusty64: 
I, [2017-03-02T16:12:20.545754 #9108]  INFO -- default-ubuntu-trusty64: Unexpected API Request Failure:
I, [2017-03-02T16:12:20.551255 #9108]  INFO -- default-ubuntu-trusty64: -------------------------------
I, [2017-03-02T16:12:20.554756 #9108]  INFO -- default-ubuntu-trusty64: Object not found: chefzero://localhost:8889/environments/development
I, [2017-03-02T16:12:20.563758 #9108]  INFO -- default-ubuntu-trusty64: 
I, [2017-03-02T16:12:20.565258 #9108]  INFO -- default-ubuntu-trusty64: Platform:
I, [2017-03-02T16:12:20.567758 #9108]  INFO -- default-ubuntu-trusty64: ---------
I, [2017-03-02T16:12:20.571759 #9108]  INFO -- default-ubuntu-trusty64: x86_64-linux
I, [2017-03-02T16:12:20.573260 #9108]  INFO -- default-ubuntu-trusty64: 
I, [2017-03-02T16:12:20.573760 #9108]  INFO -- default-ubuntu-trusty64: 
I, [2017-03-02T16:12:20.575260 #9108]  INFO -- default-ubuntu-trusty64: Running handlers:
I, [2017-03-02T16:12:20.577260 #9108]  INFO -- default-ubuntu-trusty64: [2017-03-02T10:42:20+00:00] ERROR: Running exception handlers
I, [2017-03-02T16:12:20.581261 #9108]  INFO -- default-ubuntu-trusty64: Running handlers complete
I, [2017-03-02T16:12:20.584262 #9108]  INFO -- default-ubuntu-trusty64: [2017-03-02T10:42:20+00:00] ERROR: Exception handlers complete
I, [2017-03-02T16:12:20.588763 #9108]  INFO -- default-ubuntu-trusty64: Chef Client failed. 0 resources updated in 02 seconds
I, [2017-03-02T16:12:20.592763 #9108]  INFO -- default-ubuntu-trusty64: [2017-03-02T10:42:20+00:00] FATAL: Stacktrace dumped to /tmp/kitchen/cache/chef-stacktrace.out
I, [2017-03-02T16:12:20.598265 #9108]  INFO -- default-ubuntu-trusty64: [2017-03-02T10:42:20+00:00] FATAL: Please provide the contents of the stacktrace.out file if you file a bug report
I, [2017-03-02T16:12:20.605266 #9108]  INFO -- default-ubuntu-trusty64: [2017-03-02T10:42:20+00:00] ERROR: 404 "Not Found"
I, [2017-03-02T16:12:20.608767 #9108]  INFO -- default-ubuntu-trusty64: [2017-03-02T10:42:20+00:00] FATAL: Chef::Exceptions::ChildConvergeError: Chef run process exited unsuccessfully (exit code 1)
E, [2017-03-02T16:12:20.627270 #9108] ERROR -- default-ubuntu-trusty64: Converge failed on instance <default-ubuntu-trusty64>.
E, [2017-03-02T16:12:20.627770 #9108] ERROR -- default-ubuntu-trusty64: ------Exception-------
E, [2017-03-02T16:12:20.627770 #9108] ERROR -- default-ubuntu-trusty64: Class: Kitchen::ActionFailed
E, [2017-03-02T16:12:20.627770 #9108] ERROR -- default-ubuntu-trusty64: Message: SSH exited (1) for command: [sh -c '

sudo -E /opt/chef/bin/chef-client --local-mode --config /tmp/kitchen/client.rb --log_level warn --force-formatter --no-color --json-attributes /tmp/kitchen/dna.json --chef-zero-port 8889
']
E, [2017-03-02T16:12:20.627770 #9108] ERROR -- default-ubuntu-trusty64: ---Nested Exception---
E, [2017-03-02T16:12:20.627770 #9108] ERROR -- default-ubuntu-trusty64: Class: Kitchen::Transport::SshFailed
E, [2017-03-02T16:12:20.627770 #9108] ERROR -- default-ubuntu-trusty64: Message: SSH exited (1) for command: [sh -c '

sudo -E /opt/chef/bin/chef-client --local-mode --config /tmp/kitchen/client.rb --log_level warn --force-formatter --no-color --json-attributes /tmp/kitchen/dna.json --chef-zero-port 8889
']
E, [2017-03-02T16:12:20.627770 #9108] ERROR -- default-ubuntu-trusty64: ------Backtrace-------
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/provisioner/base.rb:76:in `rescue in call'
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/provisioner/base.rb:79:in `call'
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/instance.rb:373:in `block in converge_action'
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/instance.rb:513:in `call'
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/instance.rb:513:in `synchronize_or_call'
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/instance.rb:478:in `block in action'
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/2.1.0/benchmark.rb:279:in `measure'
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/instance.rb:477:in `action'
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/instance.rb:369:in `converge_action'
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/instance.rb:348:in `block in transition_to'
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/instance.rb:347:in `each'
E, [2017-03-02T16:12:20.628271 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/instance.rb:347:in `transition_to'
E, [2017-03-02T16:12:20.628771 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/instance.rb:138:in `converge'
E, [2017-03-02T16:12:20.628771 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/command.rb:176:in `public_send'
E, [2017-03-02T16:12:20.628771 #9108] ERROR -- default-ubuntu-trusty64: G:/Tools/chefdk/embedded/lib/ruby/gems/2.1.0/gems/test-kitchen-1.6.0/lib/kitchen/command.rb:176:in `block (2 levels) in run_action'
E, [2017-03-02T16:12:20.628771 #9108] ERROR -- default-ubuntu-trusty64: ----------------------
