================================================
        AUDITING DATABASE ACTIVITIES
================================================
https://oracle-base.com/articles/10g/auditing-10gr2
https://docs.oracle.com/cd/B28359_01/network.111/b28528/concepts.htm#DBIMI222 --> auditing concepts
https://docs.oracle.com/cd/B28359_01/network.111/b28531/auditing.htm#DBSEG006 --> auditing setup
http://docs.oracle.com/cd/E25054_01/network.1111/e16543/auditing.htm#BCGIDBFI --> auditing setup

AUDIT_SYS_OPERATIONS parameter
http://docs.oracle.com/cloud/latest/db112/REFRN/initparams015.htm#REFRN10005

AUDIT_TRAIL parameter
https://docs.oracle.com/cloud/latest/db112/REFRN/initparams017.htm#REFRN10006

AUDIT_SYSLOG_LEVEL parameter
http://docs.oracle.com/cloud/latest/db112/REFRN/initparams016.htm#REFRN10263
How to use it: http://docs.oracle.com/cloud/latest/db112/DBSEG/auditing.htm#DBSEG66112

===============================
FOREMOST - SYS OPERATIONS AUDIT
===============================
1. SYS operations are ALWAYS LOGGED IN OS - NOT IN DB AUD$ TABLE
2. On UNIX platforms, if the AUDIT_SYSLOG_LEVEL parameter has also been set, 
   then it overrides the AUDIT_TRAIL parameter and SYS audit records are written to the system audit log using the SYSLOG utility.
3. AUDIT_TRAIL = db or 'db extended' - WILL NOT make SYS audit records go to DB
4. AUDIT_TRAIL = xml or xml exteded - will create the audits files in xml format
5. Even bind variable and other values in SQLs also get listed.

=============================
AUDIT INFO VIEWS
=============================
http://www.dba-oracle.com/security/checking_audit_objects.htm

TABLE_NAME
------------------------------
ALL_AUDIT_POLICIES
ALL_AUDIT_POLICY_COLUMNS
ALL_DEF_AUDIT_OPTS
ALL_REPAUDIT_ATTRIBUTE
ALL_REPAUDIT_COLUMN
AUDIT_ACTIONS
DBA_AUDIT_EXISTS
DBA_AUDIT_MGMT_CLEANUP_JOBS
DBA_AUDIT_MGMT_CLEAN_EVENTS
DBA_AUDIT_MGMT_CONFIG_PARAMS
DBA_AUDIT_MGMT_LAST_ARCH_TS
DBA_AUDIT_OBJECT --> actions done on objects
DBA_AUDIT_POLICIES
DBA_AUDIT_POLICY_COLUMNS
DBA_AUDIT_SESSION --> logon and logoff
DBA_AUDIT_STATEMENT
DBA_AUDIT_TRAIL --> logon, logoff and other actions (may not have some actions that are in DBA_AUDIT_OBJECT)
DBA_COMMON_AUDIT_TRAIL --> standard and fine-grained audit trails       
DBA_FGA_AUDIT_TRAIL
DBA_OBJ_AUDIT_OPTS --> describes auditing options on all objects
DBA_PRIV_AUDIT_OPTS --> describes current system privileges being audited across the system (user_name NULL if systemwide)
DBA_REPAUDIT_ATTRIBUTE
DBA_REPAUDIT_COLUMN
DBA_STMT_AUDIT_OPTS --> current system (not object level) auditing options across the system
GV$XML_AUDIT_TRAIL
USER_AUDIT_OBJECT
USER_AUDIT_POLICIES
USER_AUDIT_POLICY_COLUMNS
USER_AUDIT_SESSION
USER_AUDIT_STATEMENT
USER_AUDIT_TRAIL
USER_OBJ_AUDIT_OPTS
USER_REPAUDIT_ATTRIBUTE
USER_REPAUDIT_COLUMN
V$XML_AUDIT_TRAIL

-----------------------------
DBA_PRIV_AUDIT_OPTS --> describes current system privileges being audited across the system (user_name NULL if systemwide)
-----------------------------

Following actions will be audited systemwide

ALTER ANY PROCEDURE
ALTER ANY TABLE
ALTER DATABASE
ALTER PROFILE
ALTER SYSTEM
ALTER USER
AUDIT SYSTEM
CREATE ANY JOB
CREATE ANY LIBRARY
CREATE ANY PROCEDURE
CREATE ANY TABLE
CREATE EXTERNAL JOB
CREATE PUBLIC DATABASE LINK
CREATE SESSION
CREATE USER
DROP ANY PROCEDURE
DROP ANY TABLE
DROP PROFILE
DROP USER
EXEMPT ACCESS POLICY
GRANT ANY OBJECT PRIVILEGE
GRANT ANY PRIVILEGE
GRANT ANY ROLE


=============================
Auditing enhancements in 11g
=============================
https://oracle-base.com/articles/11g/auditing-enhancements-11gr2
        Oracle 11g Release 1 turned on auditng by default for the first time. Oracle 11g Release 2 now allows better management 
        of the audit trail using the DBMS_AUDIT_MGMT package.

        Moving the Database Audit Trail to a Different Tablespace
        Controlling the Size and Age of the OS Audit Trail
        Purging Audit Trail Records
        Initializing the Management Infrastructure
        Timestamp Management
        Manual Purge
        Automated Purging
        
================================
AUDITING DB ACTIVITIES - NON SYS
================================

---------------------
SETUP
---------------------
audit_sys_operations                 boolean   TRUE
audit_trail                          string    DB

------------------------
SETTING SPECIFIC AUDITS
------------------------
NOTE: In the case of enterprise users, set this for the global user.

NOTE: Aggregation of audits
        BY SESSION 
        Specify BY SESSION if you want Oracle Database to write a single record for all SQL statements of the same type 
        issued and operations of the same type executed on the same schema objects in the same session.

        BY ACCESS 
        Specify BY ACCESS if you want Oracle Database to write one record for each audited statement and operation.

$ CONNECT sys/password AS SYSDBA
SQL> AUDIT ALL BY USER1 BY ACCESS;
SQL> AUDIT SELECT TABLE, UPDATE TABLE, INSERT TABLE, DELETE TABLE BY USER1 BY ACCESS;
SQL> AUDIT EXECUTE PROCEDURE BY USER1 BY ACCESS;

-----------------------------------------
QUERY AUDIT INFORMATION FROM DB VIEWS
-----------------------------------------set pages 1000
set lines 120

column username format a30
column comment_text format a90

-- To list actions of the LDAP global user
-- Note: GLOBAL_UID shows the actual user that did the action - actual user using this UID should be looked up in LDAP like OID
-- See DocID465674.1

select username, GLOBAL_UID, PROXY_SESSIONID, to_char(timestamp, 'DD-MON-YYYY HH24:MI:SS'), 
    to_char (logoff_time, 'DD-MON-YYYY HH24:MI:SS'), owner, obj_name, action_name, ses_actions, 
    comment_text, sql_text 
    from dba_audit_trail where username=upper('oud_global_user') order by timestamp;

-- If the user is global user then the actions logged against the specific user will be only logon with logoff time
select username, GLOBAL_UID, PROXY_SESSIONID, to_char(timestamp, 'DD-MON-YYYY HH24:MI:SS'), 
    to_char (logoff_time, 'DD-MON-YYYY HH24:MI:SS'), owner, obj_name, action_name, ses_actions, 
    comment_text, sql_text 
    from dba_audit_trail where username in ('USER1','USER2','USER3') order by timestamp;

=====================================
SYS OPERATIONS AUDITING IN TRACES 
=====================================
NOTE: DB OR 'DB, EXTENDED' provide machine name in the top of the audit file only.
      XML or 'XML, EXTENDED' provide the machine name in every record in the audit file.
      
---------------------
SETUP
---------------------
audit_sys_operations                 boolean   TRUE
audit_trail                          string    DB, EXTENDED
audit_dump_dest                      /u02/app/oracle/admin/DB_UNIQUE_NAME/adump

-----------------------
SYS AS ORACLE unix USER (and do some CLEANUP also)
-----------------------
NOTE: This cleanup as sys user itself using 'oracle' os user
NOTE: This cleanup will show up in audit files

$ id 
uid=601(oracle) ... ...

$ sqlplus / as sysdba

SQL> delete sys.aud$;
SQL> commit;
SQL> select * from aud$;
no rows selected

This shows up in a .aud file in the audit_dump_dest as follows:
NOTE: For the same session, subsequent operations will be appended to the file
NOTE: LINES OF INTEREST ARE: These show 'who did it'
        DATABASE USER:[1] '/'
        PRIVILEGE :[6] 'SYSDBA'
        CLIENT USER:[6] 'oracle'
        CLIENT TERMINAL:[5] 'pts/1'

Thu Jan 19 23:30:58 2017 -06:00
LENGTH : '165'
ACTION :[11] 'delete aud$'
DATABASE USER:[1] '/'
PRIVILEGE :[6] 'SYSDBA'
CLIENT USER:[6] 'oracle'
CLIENT TERMINAL:[5] 'pts/1'
STATUS:[1] '0'
DBID:[10] '3137429114'

Thu Jan 19 23:31:00 2017 -06:00
LENGTH : '159'
ACTION :[6] 'commit'
DATABASE USER:[1] '/'
PRIVILEGE :[6] 'SYSDBA'
CLIENT USER:[6] 'oracle'
CLIENT TERMINAL:[5] 'pts/1'
STATUS:[1] '0'
DBID:[10] '3137429114'

Thu Jan 19 23:32:18 2017 -06:00
LENGTH : '172'
ACTION :[18] 'SELECT * FROM AUD$'
DATABASE USER:[1] '/'
PRIVILEGE :[6] 'SYSDBA'
CLIENT USER:[6] 'oracle'
CLIENT TERMINAL:[5] 'pts/1'
STATUS:[1] '0'
DBID:[10] '3137429114'

-------------------------------------------------------------------------------------
SYS WITH YOUR-OWN OS/USER - WHICH BELONGS TO SYSDBA OS GROUP - AND DO SOME OPERATIONS
-------------------------------------------------------------------------------------

$ id
uid=22601(mylandid)

$ sqlplus / as sysdba

SQL> delete sys.aud$;
SQL> commit;

The audit file contents:

Thu Jan 19 23:39:14 2017 -06:00
LENGTH : '165'
ACTION :[11] 'delete aud$'
DATABASE USER:[1] '/'
PRIVILEGE :[6] 'SYSDBA'
CLIENT USER:[6] 'dbgsm0'
CLIENT TERMINAL:[5] 'pts/1'
STATUS:[1] '0'
DBID:[10] '3137429114'

Thu Jan 19 23:39:36 2017 -06:00
LENGTH : '159'
ACTION :[6] 'commit'
DATABASE USER:[1] '/'
PRIVILEGE :[6] 'SYSDBA'
CLIENT USER:[6] 'dbgsm0'
CLIENT TERMINAL:[5] 'pts/1'
STATUS:[1] '0'
DBID:[10] '3137429114'

- MORE SQL WORK
SQL> create table x.emp (id number, name varchar2(10));
Table created.

SQL> desc x.emp;

-- AUDIT TRAIL FILE CONTENT FOR THEM
Thu Jan 19 23:45:00 2017 -06:00
LENGTH : '203'
ACTION :[49] 'create table x.emp (id number, name varchar2(10))'
DATABASE USER:[1] '/'
PRIVILEGE :[6] 'SYSDBA'
CLIENT USER:[6] 'dbgsm0'
CLIENT TERMINAL:[5] 'pts/1'
STATUS:[1] '0'
DBID:[10] '3137429114'

Thu Jan 19 23:45:12 2017 -06:00
LENGTH : '170'
ACTION :[14] 'OCIDescribeAny'
DATABASE USER:[3] 'SYS'
PRIVILEGE :[6] 'SYSDBA'
CLIENT USER:[6] 'dbgsm0'
CLIENT TERMINAL:[5] 'pts/1'
STATUS:[1] '0'
DBID:[10] '3137429114'

---------------------------------------------------------
XML AUDIT FILE CONTENTS - FOR SIMILAR OPERATIONS AS ABOVE
---------------------------------------------------------
<AuditRecord><Audit_Type>8</Audit_Type><EntryId>1</EntryId><Extended_Timestamp>2017-01-20T06:04:06.146147Z</Extended_Timestamp><DB_User>/</DB_User><OS_User>mylanid</OS_User><Userhost>machinename</Userhost><OS_Process>14088</OS_Process><Terminal>pts/1</Terminal><Instance_Number>1</Instance_Number><Returncode>0</Returncode><OSPrivilege>SYSDBA</OSPrivilege><DBID>3137429114</DBID>
<Sql_Text>CONNECT</Sql_Text>
</AuditRecord>
<AuditRecord><Audit_Type>4</Audit_Type><Session_Id>4294967295</Session_Id><StatementId>0</StatementId><EntryId>2</EntryId><Extended_Timestamp>2017-01-20T06:04:06.150136Z</Extended_Timestamp><DB_User>/</DB_User><Ext_Name>mylanid</Ext_Name><OS_User>mylanid</OS_User><Userhost>machinename</Userhost><OS_Process>14088</OS_Process><Terminal>pts/1</Terminal><Instance_Number>1</Instance_Number><Returncode>0</Returncode><OSPrivilege>SYSDBA</OSPrivilege><DBID>3137429114</DBID>
<Sql_Text>COMMIT</Sql_Text>
</AuditRecord>
<AuditRecord><Audit_Type>4</Audit_Type><Session_Id>4294967295</Session_Id><StatementId>0</StatementId><EntryId>3</EntryId><Extended_Timestamp>2017-01-20T06:04:06.150530Z</Extended_Timestamp><DB_User>/</DB_User><Ext_Name>mylanid</Ext_Name><OS_User>mylanid</OS_User><Userhost>machinename</Userhost><OS_Process>14088</OS_Process><Terminal>pts/1</Terminal><Instance_Number>1</Instance_Number><Returncode>0</Returncode><OSPrivilege>SYSDBA</OSPrivilege><DBID>3137429114</DBID>
<Sql_Text>COMMIT</Sql_Text>
</AuditRecord>
<AuditRecord><Audit_Type>4</Audit_Type><Session_Id>4294967295</Session_Id><StatementId>1</StatementId><EntryId>4</EntryId><Extended_Timestamp>2017-01-20T06:04:26.447820Z</Extended_Timestamp><DB_User>/</DB_User><Ext_Name>mylanid</Ext_Name><OS_User>mylanid</OS_User><Userhost>machinename</Userhost><OS_Process>14088</OS_Process><Terminal>pts/1</Terminal><Instance_Number>1</Instance_Number><Returncode>0</Returncode><OSPrivilege>SYSDBA</OSPrivilege><DBID>3137429114</DBID>
<Sql_Text>delete aud$</Sql_Text>
</AuditRecord>
<AuditRecord><Audit_Type>4</Audit_Type><Session_Id>4294967295</Session_Id><StatementId>2</StatementId><EntryId>5</EntryId><Extended_Timestamp>2017-01-20T06:04:30.813160Z</Extended_Timestamp><DB_User>/</DB_User><Ext_Name>mylanid</Ext_Name><OS_User>mylanid</OS_User><Userhost>machinename</Userhost><OS_Process>14088</OS_Process><Terminal>pts/1</Terminal><Instance_Number>1</Instance_Number><Returncode>0</Returncode><Scn>33584366</Scn><OSPrivilege>SYSDBA</OSPrivilege><DBID>3137429114</DBID>
<Sql_Text>select * from aud$</Sql_Text>
</AuditRecord>
<AuditRecord><Audit_Type>4</Audit_Type><Session_Id>4294967295</Session_Id><StatementId>3</StatementId><EntryId>6</EntryId><Extended_Timestamp>2017-01-20T06:04:35.906843Z</Extended_Timestamp><DB_User>/</DB_User><Ext_Name>mylanid</Ext_Name><OS_User>mylanid</OS_User><Userhost>machinename</Userhost><OS_Process>14088</OS_Process><Terminal>pts/1</Terminal><Instance_Number>1</Instance_Number><Returncode>0</Returncode><OSPrivilege>SYSDBA</OSPrivilege><DBID>3137429114</DBID>
<Sql_Text>commit</Sql_Text>
</AuditRecord>

-----------------------------
STARTUP AND SHUTDOWN ACTIONS  (DIRECTLY ON DB SERVER)
-----------------------------

- Shutdown using srvctl and sqlplus seemed to record the privileged o/s user 'oracle' instead of the os user that did srvctl operation
NOTE: With XML setting, shutdown appeared in a xml file (unlike startup appearing in a .aud file)
NOTE: <OS_User>oracle</OS_User> in the listing below
...
...
<AuditRecord><Audit_Type>4</Audit_Type><Session_Id>4294967295</Session_Id><StatementId>4</StatementId><EntryId>5</EntryId><Extended_Timestamp>2017-01-20T06:34:30.853507Z</Extended_Timestamp><DB_User>/</DB_User><Ext_Name>oracle</Ext_Name><OS_User>oracle</OS_User><Userhost>db-host-name</Userhost><OS_Process>38078</OS_Process><Instance_Number>1</Instance_Number><Returncode>0</Returncode><OSPrivilege>SYSDBA</OSPrivilege>
<Sql_Text>ALTER DATABASE DISMOUNT /* db agent *//* {1:56856:18033} */</Sql_Text>
</AuditRecord>
<AuditRecord><Audit_Type>8</Audit_Type><EntryId>6</EntryId><Extended_Timestamp>2017-01-20T06:34:30.854788Z</Extended_Timestamp><DB_User>/</DB_User><OS_User>oracle</OS_User><Userhost>db-host-name</Userhost><OS_Process>38078</OS_Process><Instance_Number>1</Instance_Number><Returncode>0</Returncode><OSPrivilege>SYSDBA</OSPrivilege>
<Sql_Text>SHUTDOWN</Sql_Text>
</AuditRecord>

- Startup using sqlplus seemed to record the os user that did sqlplus-startup operation
NOTE: With XML setting, it was a combination of .aud plain text file and a .xml file
NOTE: With XML setting, the .aud file had the SHUTDOWN entry as below (also note that DBID does not have a value in it)
        Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production
        With the Partitioning, Real Application Clusters, OLAP, Data Mining
        and Real Application Testing options
        ORACLE_HOME = /u02/app/oracle/product/11.2.0.4.RAC
        System name:    Linux
        Node name:      db-hostname.com
        Release:        2.6.32-573.22.1.el6.x86_64
        Version:        #1 SMP Thu Mar 17 03:23:39 EDT 2016
        Machine:        x86_64
        Instance name: DB-INSTANCE-NAME
        Redo thread mounted by this instance: 0 <none>
        Oracle process number: 0
        Unix process pid: 44686, image: oracle@db-hostname.com

        Fri Jan 20 00:37:42 2017 -06:00
        LENGTH : '156'
        ACTION :[7] 'STARTUP'
        DATABASE USER:[1] '/'
        PRIVILEGE :[4] 'NONE'
        CLIENT USER:[6] 'mylanid'
        CLIENT TERMINAL:[13] 'Not Available'
        STATUS:[1] '0'
        DBID:[0] ''


